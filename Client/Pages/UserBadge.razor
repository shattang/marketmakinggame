@implements IDisposable
@using Lib
@inject AppViewModel AppViewModel

<MatDialog @bind-IsOpen="@AppViewModel.UserDataEditorViewModel.IsUserDataEditorOpen" CanBeClosed="false">
  <MatDialogTitle>Display Name and Avatar</MatDialogTitle>
  <MatDialogContent>
    <UserDataEditor />
  </MatDialogContent>
  <MatDialogActions>
    <MatButton OnClick="@OnUserDataEditorDialogClickOk">OK</MatButton>
  </MatDialogActions>
</MatDialog>

<MatButton OnClick="@OpenUserDataEditorDialog">
  <img src="@AppViewModel.UserDataEditorViewModel.AvatarUrl" width=32 height=32 />
  @AppViewModel.UserDataEditorViewModel.DisplayName
</MatButton>

@code
{
  protected override async Task OnInitializedAsync()
  {
    AppViewModel.UserDataEditorViewModel.StateChanged += OnUserDataViewModelChanged;
    await AppViewModel.InitializeAsync();
  }

  void OnUserDataViewModelChanged(EventArgs e)
  {
    StateHasChanged();
  }

  void OpenUserDataEditorDialog()
  {
    AppViewModel.UserDataEditorViewModel.IsUserDataEditorOpen = true;
  }

  void OnUserDataEditorDialogClickOk()
  {
    var res = AppViewModel.UserDataEditorViewModel.CheckValid();
    if (!res.Success)
      return;
    AppViewModel.UserDataEditorViewModel.IsUserDataEditorOpen = false;
  }

  public void Dispose()
  {
    AppViewModel.UserDataEditorViewModel.StateChanged -= OnUserDataViewModelChanged;
  }
}
